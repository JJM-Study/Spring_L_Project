<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="org.example.myproject.product.mapper.ProductMapper">

    <select id="selectProductList" resultType="org.example.myproject.product.dto.ProductDto">
<!--        select a.prod_no, a.prod_name, a.price, a.stock_qty, a.crt_dt, a.del_dt, b.image_url, c.prod_no IS NOT NULL AS is_in_cart-->
        select a.prod_no, a.prod_name, a.price, a.prod_type, a.stock_qty, a.crt_dt, a.del_dt, b.image_url, c.prod_no IS NOT NULL AS is_in_cart, d.prod_no IS NOT NULL as is_in_lyb
        from product_master a
        left join product_image b on a.prod_no = b.prod_no AND b.is_main = 1
        left join order_cart c on a.prod_no = c.prod_no AND c.user_id = #{userId}
        left join user_library d on a.prod_no = d.prod_no and d.user_id = #{userId}
        where a.del_yn = 0
        <if test="title != '' and title != null">
            AND prod_name LIKE CONCAT('%', #{title}, '%')
        </if>
        limit #{pageSize} offset #{offset};
    </select>

    <!--    <select id="selectProductDetail" parameterType="string" resultType="org.example.myproject.product.model.ProductDetailDto">-->
    <!--        select a.prod_no, a.prod_name, a.price, a.stock_qty, a.crt_dt, a.del_dt,-->
    <!--        b.image_url-->
    <!--        from product_master a-->
    <!--        left join product_image b on a.prod_no = b.prod_no-->
    <!--        where a.del_yn = 'N' and a.prod_no = #{prodNo}-->
    <!--    </select>-->

    <select id="selectProductDetail" resultMap="ProductDetailMap">
        select a.prod_no, a.prod_name, a.price, a.stock_qty, a.crt_dt, a.del_dt, a.sales_dt,
        b.image_url, b.is_main, b.sort_order, c.detail_desc, c.notice, c.shipping_info, c.additional_info,
        a.seller_id, a.prod_type, d.prod_no IS NOT NULL as is_in_lyb
        from product_master a
        left join product_image b on a.prod_no = b.prod_no
        left join product_detail c on a.prod_no = c.prod_no

        left join user_library d on a.prod_no = d.prod_no and a.prod_type != "PHYSICAL" and d.user_id = #{userId}

        where a.del_yn = 0 and a.prod_no = #{prodNo}
        order by b.sort_order
    </select>

    <resultMap id="ProductDetailMap" type="org.example.myproject.product.dto.ProductDetailDto">
        <id property="prodNo" column="prod_no" />
        <result property="prodName" column="prod_name" />
        <result property="price"    column="price" />

        <result property="prodType" column="prod_type" />

        <result property="sellerId" column="seller_id" />

        <result property="stockQty" column="stock_qty" />

        <result property="salesDt"    column="sales_dt" />

        <result property="crtDt"    column="crt_dt" />
        <result property="delDt"    column="del_dt" />

        <result property="detailDesc" column="detail_desc" />
        <result property="notice" column="notice" />
        <result property="shippingInfo" column="shipping_info" />
        <result property="additionalInfo" column="additional_info" />

        <result property="isInLyb" column="is_in_lyb" />

        <!-- imageUrl은 리스트니까 collection 사용 -->
        <collection property="imageList" ofType="org.example.myproject.product.dto.ProductImageDto">
            <result property="imageUrl" column="image_url" />
            <result property="isMain" column="is_main" />
            <result property="sortOrder" column="sort_order" />
        </collection>

    </resultMap>

    <select id="selectProductPrice" resultType="org.example.myproject.product.dto.ProductPriceDto">
        SELECT prod_no, price
        FROM product_master
        WHERE prod_no IN
        <foreach collection="prodNos" item="prodNo" open="(" separator="," close=")">
            #{prodNo}
        </foreach>
    </select>

    <select id="selectProductCount" resultType="int">
        SELECT count(*)
        FROM product_master
        WHERE del_yn = 0
        <if test="title != null and title != ''">
            AND prod_name LIKE CONCAT('%', #{title}, '%')
        </if>
    </select>


    <select id="selectNowOrdProduct" resultType="org.example.myproject.product.dto.ProductDto">
        select * from product_master WHERE prod_no = #{prodNo};
    </select>

    <select id="selectImagesByProdNos" resultType="org.example.myproject.product.dto.ProductImageDto" >
        select a.prod_no, b.is_main, b.image_url, b.sort_order from product_master as a
        inner join product_image as b on a.prod_no = b.prod_no
        where a.prod_no in
        <foreach item="item" collection="list" open="(" separator="," close=")">
            #{item}
        </foreach>
    </select>

    <!-- 2025.11.19 Best Seller 추가 -->
    <select id="displayBestProducts" resultType="org.example.myproject.product.dto.ProductBestsellerDto">
        select
            b.sales_count,
            b.rating,
            a.sales_dt,
            a.prod_no,
            a.prod_name,
            a.prod_type,
            a.price,
            a.seller_id,
            c.image_url,
            e.cart_no IS NOT NULL isInCart,
            d.prod_no IS NOT NULL as isInLyb
        from product_master as a
        inner join product_status as b on a.prod_no = b.prod_no
        left join product_image as c on a.prod_no = c.prod_no and c.is_main = 1
        left join user_library as d on a.prod_no = d.prod_no and d.user_id = #{userId}
        left join order_cart as e on a.prod_no = e.prod_no and e.user_id = #{userId}
        where a.sales_dt > date_sub(NOW(), INTERVAL 10 YEAR)
        order by b.sales_count desc, b.rating desc, a.sales_dt desc
        LIMIT 0, 10
    </select>


    <update id="updateSalesCount">
        <foreach collection="list" item="item" separator=";">
            UPDATE product_status
            SET sales_count = sales_count + #{item.qty}
            WHERE prod_no = #{item.prodNo}
        </foreach>
    </update>
</mapper>
